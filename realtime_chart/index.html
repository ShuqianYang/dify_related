<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ========== 页面基础配置 ========== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动物识别实时图表系统 v2.0</title>
    
    <!-- 强制刷新缓存 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ========== ECharts 图表库动态加载 ========== -->
    <!-- 使用多个备用CDN确保ECharts库能够成功加载 -->
    <script>
        /**
         * 动态加载ECharts库函数
         * 功能：尝试从多个CDN源加载ECharts，提高加载成功率
         * 特点：自动故障转移，如果一个CDN失败会尝试下一个
         */
        function loadECharts() {
            // 定义多个ECharts CDN源，按优先级排序
            const cdnList = [
                'https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js',       // BootCDN (主要)
                'https://registry.npmmirror.com/echarts/5.4.3/files/dist/echarts.min.js', // 阿里云镜像 (备用1)
                'https://cdn.staticfile.org/echarts/5.4.3/echarts.min.js'                // 七牛云 (备用2)
            ];
            
            let currentIndex = 0; // 当前尝试的CDN索引
            
            /**
             * 尝试加载脚本函数
             * 递归调用，直到成功加载或所有CDN都失败
             */
            function tryLoadScript() {
                // 如果所有CDN都尝试过了，显示错误
                if (currentIndex >= cdnList.length) {
                    console.error('所有ECharts CDN都无法加载');
                    return;
                }
                
                // 创建script标签动态加载
                const script = document.createElement('script');
                script.src = cdnList[currentIndex];
                
                // 加载成功回调
                script.onload = function() {
                    console.log('ECharts加载成功:', cdnList[currentIndex]);
                    console.log('ECharts版本:', echarts.version);
                    initializeCharts(); // 初始化图表
                };
                
                // 添加控制台调试信息
                window.onerror = function(msg, url, lineNo, columnNo, error) {
                    console.error('页面错误:', msg);
                    console.error('错误位置:', url, '行:', lineNo, '列:', columnNo);
                    console.error('错误详情:', error);
                    return false;
                };
                
                // 加载失败回调，尝试下一个CDN
                script.onerror = function() {
                    console.log('CDN加载失败:', cdnList[currentIndex]);
                    currentIndex++;
                    tryLoadScript(); // 递归尝试下一个CDN
                };
                
                // 将script标签添加到页面头部
                document.head.appendChild(script);
            }
            
            tryLoadScript(); // 开始尝试加载
        }
        
        // 页面DOM加载完成后开始加载ECharts库
        document.addEventListener('DOMContentLoaded', loadECharts);
    </script>
    <!-- ========== 页面样式定义 ========== -->
    <style>
        /* ========== 全局样式重置和基础设置 ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* 确保padding和border包含在元素宽度内 */
        }

        /* ========== 页面主体样式 ========== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* 现代化字体栈 */
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 50%, #69c0ff 100%); /* 蓝色渐变背景 */
            min-height: 100vh; /* 最小高度为视窗高度 */
            padding: 20px; /* 页面内边距 */
        }

        /* ========== 主容器样式 ========== */
        .container {
            max-width: 1400px; /* 最大宽度限制 */
            margin: 0 auto; /* 水平居中 */
            background: rgba(255, 255, 255, 0.95); /* 半透明白色背景 */
            border-radius: 20px; /* 圆角边框 */
            box-shadow: 0 20px 40px rgba(24, 144, 255, 0.2); /* 蓝色阴影效果 */
            overflow: hidden; /* 隐藏溢出内容 */
            border: 2px solid rgba(24, 144, 255, 0.3); /* 蓝色边框 */
        }

        /* ========== 页面标题样式 ========== */
        .header {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 50%, #0050b3 100%); /* 蓝色渐变背景 */
            color: white; /* 白色文字 */
            text-align: center; /* 文字居中 */
            padding: 30px; /* 内边距 */
            position: relative; /* 相对定位 */
        }

        .header h1 {
            font-size: 2.5em; /* 大标题字体大小 */
            margin-bottom: 10px; /* 下边距 */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* 文字阴影 */
        }

        .header p {
            font-size: 1.1em; /* 副标题字体大小 */
            opacity: 0.9; /* 透明度 */
        }

        /* ========== 控制面板样式 ========== */
        .controls {
            background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); /* 浅蓝色渐变背景 */
            padding: 20px; /* 内边距 */
            border-bottom: 1px solid #40a9ff; /* 蓝色底部边框 */
            display: flex; /* 弹性布局 */
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
            gap: 20px; /* 元素间距 */
            flex-wrap: wrap; /* 允许换行 */
        }

        /* ========== 按钮样式 ========== */
        .btn {
            padding: 12px 24px; /* 内边距 */
            border: none; /* 无边框 */
            border-radius: 25px; /* 圆角 */
            cursor: pointer; /* 鼠标指针 */
            font-size: 14px; /* 字体大小 */
            font-weight: 600; /* 字体粗细 */
            transition: all 0.3s ease; /* 过渡动画 */
            text-transform: uppercase; /* 大写字母 */
            letter-spacing: 0.5px; /* 字母间距 */
        }

        /* 主要按钮样式 */
        .btn-primary {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%); /* 蓝色渐变背景 */
            color: white; /* 白色文字 */
            border: 2px solid #0050b3; /* 深蓝色边框 */
        }

        .btn-primary:hover {
            transform: translateY(-2px); /* 悬停上移效果 */
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4); /* 蓝色悬停阴影 */
            background: linear-gradient(135deg, #0050b3 0%, #1890ff 100%); /* 悬停时反转渐变 */
        }

        /* 成功按钮样式 */
        .btn-success {
            background: linear-gradient(135deg, #1890ff 0%, #69c0ff 100%); /* 浅蓝色渐变 */
            color: white;
            border: 2px solid #40a9ff; /* 蓝色边框 */
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 169, 255, 0.4);
            background: linear-gradient(135deg, #40a9ff 0%, #1890ff 100%);
        }

        /* 危险按钮样式 */
        .btn-danger {
            background: linear-gradient(135deg, #0050b3 0%, #003a8c 100%); /* 深蓝色渐变 */
            color: white;
            border: 2px solid #002766; /* 更深蓝色边框 */
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 80, 179, 0.4);
            background: linear-gradient(135deg, #003a8c 0%, #0050b3 100%);
        }

        /* ========== 状态指示器样式 ========== */
        .status {
            display: flex; /* 弹性布局 */
            align-items: center; /* 垂直居中 */
            gap: 10px; /* 元素间距 */
            padding: 10px 20px; /* 内边距 */
            border-radius: 20px; /* 圆角 */
            font-weight: 600; /* 字体粗细 */
            font-size: 14px; /* 字体大小 */
        }

        /* 状态指示灯样式 */
        .status-indicator {
            width: 12px; /* 宽度 */
            height: 12px; /* 高度 */
            border-radius: 50%; /* 圆形 */
            animation: pulse 2s infinite; /* 脉冲动画 */
        }

        /* 运行状态样式 */
        .status.running {
            background: rgba(24, 144, 255, 0.1); /* 浅蓝色背景 */
            color: #1890ff; /* 蓝色文字 */
            border: 1px solid rgba(24, 144, 255, 0.3); /* 蓝色边框 */
        }

        .status.running .status-indicator {
            background: #1890ff; /* 蓝色指示灯 */
        }

        /* 停止状态样式 */
        .status.stopped {
            background: rgba(0, 80, 179, 0.1); /* 深蓝色背景 */
            color: #0050b3; /* 深蓝色文字 */
            border: 1px solid rgba(0, 80, 179, 0.3); /* 深蓝色边框 */
        }

        .status.stopped .status-indicator {
            background: #0050b3; /* 深蓝色指示灯 */
            animation: none; /* 无动画 */
        }

        /* ========== 脉冲动画定义 ========== */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(24, 144, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(24, 144, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(24, 144, 255, 0);
            }
        }

        /* ========== 图表网格布局 ========== */
        /* 使用CSS Grid创建响应式的图表布局 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* 自适应列数，最小宽度400px */
            gap: 20px; /* 图表间距 */
            padding: 20px;
            max-width: 1400px; /* 限制最大宽度 */
            margin: 0 auto; /* 居中显示 */
        }

        /* ========== 单个图表容器样式 ========== */
        .chart-container {
            background: white; /* 白色背景 */
            border-radius: 15px; /* 圆角 */
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.15); /* 蓝色阴影 */
            overflow: hidden; /* 隐藏溢出 */
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* 过渡动画 */
            border: 2px solid rgba(24, 144, 255, 0.2); /* 蓝色边框 */
        }

        .chart-container:hover {
            transform: translateY(-5px); /* 悬停上移 */
            box-shadow: 0 10px 25px rgba(24, 144, 255, 0.25); /* 蓝色悬停阴影 */
            border-color: rgba(24, 144, 255, 0.4); /* 悬停时加深边框 */
        }

        /* ========== 图表标题样式 ========== */
        .chart-title {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 50%, #69c0ff 100%); /* 蓝色渐变背景 */
            color: white; /* 白色文字 */
            padding: 15px 20px; /* 内边距 */
            font-size: 1.2em; /* 字体大小 */
            font-weight: 600; /* 字体粗细 */
            text-align: center; /* 文字居中 */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* 文字阴影 */
        }

        /* ========== 图表内容区域样式 ========== */
        .chart {
            width: 100%; /* 全宽 */
            height: 400px; /* 固定高度 */
            padding: 10px; /* 内边距 */
        }

        /* ========== 响应式设计 ========== */
        /* 平板设备适配 */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr; /* 单列布局 */
                gap: 15px; /* 减小间距 */
                padding: 15px; /* 减小内边距 */
            }
            
            .chart {
                height: 300px; /* 减小图表高度 */
            }
            
            .controls {
                flex-direction: column; /* 垂直排列 */
                gap: 15px; /* 减小间距 */
            }
            
            .header h1 {
                font-size: 2em; /* 减小标题字体 */
            }
        }

        /* 手机设备适配 */
        @media (max-width: 480px) {
            body {
                padding: 10px; /* 减小页面边距 */
            }
            
            .chart {
                height: 250px; /* 进一步减小图表高度 */
            }
            
            .btn {
                padding: 10px 20px; /* 减小按钮内边距 */
                font-size: 12px; /* 减小按钮字体 */
            }
            
            .header {
                padding: 20px; /* 减小标题内边距 */
            }
            
            .header h1 {
                font-size: 1.8em; /* 进一步减小标题字体 */
            }
        }
    </style>
</head>
<body>
    <!-- ========== 主容器 ========== -->
    <!-- 包含整个页面的所有内容，提供统一的样式和布局 -->
    <div class="container">
        <!-- ========== 页面头部 ========== -->
        <!-- 显示页面标题和描述信息 -->
        <div class="header">
            <h1>🔵 动物识别实时图表系统</h1>
            <p>基于图像回传数据的多维度可视化分析系统 - 蓝色主题版</p>
        </div>

        <!-- ========== 控制面板 ========== -->
        <!-- 提供图表控制功能，包括启动/停止实时更新和手动刷新 -->
        <div class="controls">
            <!-- 开始实时更新按钮 -->
            <button class="btn btn-success" onclick="startRealTimeUpdate()">
                ▶️ 开始实时更新
            </button>
            
            <!-- 停止实时更新按钮 -->
            <button class="btn btn-danger" onclick="stopRealTimeUpdate()">
                ⏹️ 停止实时更新
            </button>
            
            <!-- 手动刷新数据按钮 -->
            <button class="btn btn-primary" onclick="refreshAllCharts()">
                🔄 刷新数据
            </button>
            
            <!-- 实时更新状态指示器 -->
            <div class="status stopped" id="updateStatus">
                <div class="status-indicator"></div>
                <span>实时更新已停止</span>
            </div>
        </div>

        <!-- ========== 图表展示区域 ========== -->
        <!-- 使用网格布局展示三个核心图表，支持响应式设计 -->
        <div class="charts-grid">
            <!-- ========== 图表1：按日期统计的图像识别数量变化趋势 ========== -->
            <div class="chart-container">
                <div class="chart-title">📈 按日期统计的图像识别数量变化趋势</div>
                <div id="timeseriesChart" class="chart"></div>
            </div>

            <!-- ========== 图表2：不同动物种类的识别数量分布情况 ========== -->
            <div class="chart-container">
                <div class="chart-title">🦁 不同动物种类的识别数量分布情况</div>
                <div id="animalChart" class="chart"></div>
            </div>

            <!-- ========== 图表3：不同地理位置动物识别数量分布情况 ========== -->
            <div class="chart-container">
                <div class="chart-title">🌍 不同地理位置动物识别数量分布情况</div>
                <div id="locationChart" class="chart"></div>
            </div>
        </div>
    </div>

    <!-- ========== JavaScript 核心功能实现 ========== -->
    <script>
        // ========== 全局变量定义 ========== 
        // 存储所有图表实例，便于统一管理和更新
        let chartInstances = {
            timeseriesChart: null,  // 时间序列趋势图实例
            animalChart: null,      // 动物种类分布图实例
            locationChart: null     // 地理位置分布图实例
        };
        
        // 实时更新定时器，用于控制数据刷新频率
        let updateTimer = null;
        
        // 实时更新状态标识，防止重复启动
        let isRealTimeActive = false;

        /**
         * ========== 图表初始化主函数 ==========
         * 功能：在ECharts库加载完成后初始化所有图表
         * 调用时机：ECharts库动态加载成功后
         * 作用：创建图表实例、设置初始配置、加载初始数据
         */
        function initializeCharts() {
            console.log('开始初始化图表...');
            
            // 检查ECharts是否已加载
            if (typeof echarts === 'undefined') {
                console.error('ECharts库未加载');
                return;
            }

            try {
                // 初始化所有图表实例
                initializeTimeseriesChart(); // 按日期统计的图像识别数量变化趋势图
                initializeAnimalChart();     // 动物种类分布图
                initializeLocationChart();   // 地理位置分布图
                
                // 加载所有图表的初始数据
                loadAllChartsData();
                
                console.log('所有图表初始化完成');
            } catch (error) {
                console.error('图表初始化失败:', error);
            }
        }

        /**
         * ========== 按日期统计的图像识别数量变化趋势图初始化 ==========
         * 功能：创建显示按日期统计的图像识别数量变化趋势的折线图
         * 图表类型：折线图
         * 数据维度：日期 vs 识别数量
         */
        function initializeTimeseriesChart() {
            const chartDom = document.getElementById('timeseriesChart');
            chartInstances.timeseriesChart = echarts.init(chartDom);
            
            // 设置图表基础配置
            const option = {
                title: {
                    text: '按日期统计的图像识别数量变化趋势',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1890ff'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>识别数量: ${params[0].value}`;
                    }
                },
                legend: {
                    data: ['识别数量'],
                    top: 30,
                    textStyle: {
                        color: '#1890ff'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: [], // 将通过API获取数据
                    axisLabel: {
                        rotate: 45, // 旋转标签避免重叠
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '识别数量',
                    nameTextStyle: {
                        color: '#1890ff'
                    },
                    axisLabel: {
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                series: [{
                    name: '识别数量',
                    type: 'line',
                    smooth: true, // 平滑曲线
                    data: [],
                    itemStyle: {
                        color: '#1890ff',
                        borderColor: '#1890ff',
                        borderWidth: 2
                    },
                    lineStyle: {
                        color: '#1890ff',
                        width: 3
                    },
                    areaStyle: { // 添加面积填充
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: '#1890ff'
                            }, {
                                offset: 1, color: 'rgba(24, 144, 255, 0.1)'
                            }]
                        }
                    }
                }]
            };
            
            chartInstances.timeseriesChart.setOption(option);
        }

        /**
         * ========== 动物种类分布图初始化 ==========
         * 功能：创建显示不同动物种类识别数量分布的饼图
         * 图表类型：饼图
         * 数据维度：动物种类 vs 识别数量
         */
        function initializeAnimalChart() {
            // 通过 getElementById 获取 ID 为 animalChart 的 HTML 元素（例如一个 < div >）
            const chartDom = document.getElementById('animalChart');
            // 使用 echarts.init() 初始化这个图表容器，并保存到 chartInstances.animalChart 中
            //（chartInstances 可能是全局对象，用于保存多个图表实例）。
            chartInstances.animalChart = echarts.init(chartDom);
            
            // 图表配置项 option
            const option = {
                title: { //标题
                    text: '不同动物种类的识别数量分布情况',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1890ff'
                    }
                },
                tooltip: { //提示框
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: { //图例
                    orient: 'vertical',
                    left: 'left',
                    top: 'middle',
                    textStyle: {
                        color: '#1890ff'
                    }
                },
                color: [
                    '#1890ff',  // 主蓝色
                    '#40a9ff',  // 亮蓝色
                    '#69c0ff',  // 浅蓝色
                    '#91d5ff',  // 更浅蓝色
                    '#bae7ff',  // 淡蓝色
                    '#e6f7ff',  // 极淡蓝色
                    '#0050b3',  // 深蓝色
                    '#003a8c'   // 更深蓝色
                ],
                // 数据
                series: [{
                    name: '动物种类',
                    type: 'pie',
                    radius: ['40%', '70%'], // 环形饼图
                    center: ['60%', '50%'],
                    data: [],  // 初始数据为空，后续可能通过接口或函数动态设置
                    emphasis: {  // 高亮样式（鼠标悬停时）
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(24, 144, 255, 0.5)'
                        }
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {d}%',
                        color: '#1890ff'
                    },
                    labelLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                }]
            };
            // 应用配置
            chartInstances.animalChart.setOption(option);
        }

        /**
         * ========== 地理位置分布图初始化 ==========
         * 功能：创建显示不同地理位置动物识别数量分布的柱状图
         * 图表类型：柱状图
         * 数据维度：地理位置 vs 识别数量
         */
        function initializeLocationChart() {
            const chartDom = document.getElementById('locationChart');
            chartInstances.locationChart = echarts.init(chartDom);
            
            const option = {
                title: {
                    text: '不同地理位置动物识别数量分布情况',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1890ff'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>识别数量: ${params[0].value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    name: '地理位置',
                    nameTextStyle: {
                        color: '#1890ff'
                    },
                    axisLabel: {
                        interval: 0,
                        rotate: 45,
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '识别数量',
                    nameTextStyle: {
                        color: '#1890ff'
                    },
                    axisLabel: {
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                series: [{
                    name: '识别数量',
                    type: 'bar',
                    data: [],
                    itemStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: '#1890ff'
                            }, {
                                offset: 1, color: '#40a9ff'
                            }]
                        },
                        borderColor: '#1890ff',
                        borderWidth: 2
                    },
                    emphasis: {
                        itemStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: '#0050b3'
                                }, {
                                    offset: 1, color: '#1890ff'
                                }]
                            }
                        }
                    }
                }]
            };
            
            chartInstances.locationChart.setOption(option);
        }

        /**
         * ========== 数据获取和更新函数 ==========
         */

        /**
         * 加载所有图表数据
         * 功能：并行获取所有图表的数据并更新显示
         */
        async function loadAllChartsData() {
            console.log('开始加载图表数据...');
            
            try {
                // 并行获取所有数据，提高加载效率
                await Promise.all([
                    loadTimeseriesData(),
                    loadAnimalData(), 
                    loadLocationData()
                ]);
                
                console.log('所有图表数据加载完成');
            } catch (error) {
                console.error('数据加载失败:', error);
            }
        }

        /**
         * 获取时间序列数据
         * API接口：/api/timeseries-data
         * 返回格式：[{date: "2024-01-01", count: 10, confidence: 0.95, percentage: 85.5}]
         */
        async function loadTimeseriesData() {
            try {
                const response = await fetch('/api/timeseries-data');
                const data = await response.json();
                
                if (data && data.status === 'success' && Array.isArray(data.data) && chartInstances.timeseriesChart) {
                    const dates = data.data.map(item => item.date);
                    const counts = data.data.map(item => item.count);
                    
                    chartInstances.timeseriesChart.setOption({
                        xAxis: {
                            data: dates
                        },
                        series: [{
                            data: counts
                        }]
                    });
                }
            } catch (error) {
                console.error('时间序列数据获取失败:', error);
            }
        }

        /**
         * 获取动物种类分布数据
         * API接口：/api/chart-data
         * 返回格式：[{animal: "狮子", count: 25}]
         */
        async function loadAnimalData() {
            try {
                // 请求数据并解析
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                
                // data 不为空；data 是一个数组；chartInstances.animalChart（前面初始化好的 ECharts 实例）已存在。
                if (data && data.status === 'success' && Array.isArray(data.data) && chartInstances.animalChart) {
                    const pieData = data.data.map(item => ({  // 将后端格式转成 ECharts 饼图需要的格式
                        name: item.animal,
                        value: item.count
                    }));
                    
                    // 调用 ECharts 实例的 setOption 方法，向第一个 series（饼图系列）注入新的 data。
                    chartInstances.animalChart.setOption({
                        series: [{
                            data: pieData
                        }]
                    });
                }
            } catch (error) {
                console.error('动物数据获取失败:', error);
            }
        }

        /**
         * 获取地理位置分布数据
         * API接口：/api/location-data
         * 返回格式：[{location: "北京", count: 15}]
         */
        async function loadLocationData() {
            try {
                const response = await fetch('/api/location-data');
                const data = await response.json();
                
                if (data && data.status === 'success' && Array.isArray(data.data) && chartInstances.locationChart) {
                    const locations = data.data.map(item => item.location);
                    const counts = data.data.map(item => item.count);
                    
                    chartInstances.locationChart.setOption({
                        xAxis: {
                            data: locations
                        },
                        series: [{
                            data: counts
                        }]
                    });
                }
            } catch (error) {
                console.error('地理位置数据获取失败:', error);
            }
        }

        /**
         * ========== 实时更新控制函数 ==========
         */

        /**
         * 开始实时更新
         * 功能：启动定时器，定期刷新图表数据
         * 更新频率：3秒一次
         */
        function startRealTimeUpdate() {
            if (isRealTimeActive) {
                console.log('实时更新已在运行中');
                return;
            }
            
            isRealTimeActive = true;
            updateTimer = setInterval(loadAllChartsData, 3000); // 3秒更新一次
            
            // 更新状态显示
            updateStatusDisplay(true);
            console.log('实时更新已启动');
        }

        /**
         * 停止实时更新
         * 功能：清除定时器，停止自动刷新
         */
        function stopRealTimeUpdate() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
            
            isRealTimeActive = false;
            
            // 更新状态显示
            updateStatusDisplay(false);
            console.log('实时更新已停止');
        }

        /**
         * 手动刷新所有图表
         * 功能：立即更新所有图表数据，不影响实时更新状态
         */
        function refreshAllCharts() {
            console.log('手动刷新图表数据');
            loadAllChartsData();
        }

        /**
         * 更新状态显示
         * 功能：更新页面上的实时更新状态指示器
         * @param {boolean} isRunning - 是否正在运行
         */
        function updateStatusDisplay(isRunning) {
            const statusElement = document.getElementById('updateStatus');
            const statusText = statusElement.querySelector('span');
            
            if (isRunning) {
                statusElement.className = 'status running';
                statusText.textContent = '实时更新运行中';
            } else {
                statusElement.className = 'status stopped';
                statusText.textContent = '实时更新已停止';
            }
        }

        /**
         * ========== 窗口大小变化处理 ==========
         * 功能：当浏览器窗口大小改变时，自动调整图表尺寸
         */
        window.addEventListener('resize', function() {
            // 遍历所有图表实例，调用resize方法重新计算尺寸
            if (chartInstances.timeseriesChart) chartInstances.timeseriesChart.resize();
            if (chartInstances.animalChart) chartInstances.animalChart.resize();
            if (chartInstances.locationChart) chartInstances.locationChart.resize();
        });

        /**
          * ========== 页面卸载处理 ==========
          * 页面关闭或刷新时，清理资源和停止定时器
          */
         window.addEventListener('beforeunload', function() {
             // 停止实时更新
             stopRealTimeUpdate();
             
             // 销毁所有图表实例，释放内存
             if (chartInstances.timeseriesChart) {
                 chartInstances.timeseriesChart.dispose();
             }
             if (chartInstances.animalChart) {
                 chartInstances.animalChart.dispose();
             }
             if (chartInstances.locationChart) {
                 chartInstances.locationChart.dispose();
             }
         });
    </script>
</body>
</html>