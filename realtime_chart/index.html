<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ========== é¡µé¢åŸºç¡€é…ç½® ========== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨ç‰©è¯†åˆ«å®æ—¶å›¾è¡¨ç³»ç»Ÿ v2.0</title>
    
    <!-- å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- ========== ECharts å›¾è¡¨åº“åŠ¨æ€åŠ è½½ ========== -->
    <!-- ä½¿ç”¨å¤šä¸ªå¤‡ç”¨CDNç¡®ä¿EChartsåº“èƒ½å¤ŸæˆåŠŸåŠ è½½ -->
    <script>
        /**
         * åŠ¨æ€åŠ è½½EChartsåº“å‡½æ•°
         * åŠŸèƒ½ï¼šå°è¯•ä»å¤šä¸ªCDNæºåŠ è½½EChartsï¼Œæé«˜åŠ è½½æˆåŠŸç‡
         * ç‰¹ç‚¹ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œå¦‚æœä¸€ä¸ªCDNå¤±è´¥ä¼šå°è¯•ä¸‹ä¸€ä¸ª
         */
        function loadECharts() {
            // å®šä¹‰å¤šä¸ªECharts CDNæºï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
            const cdnList = [
                'https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js',       // BootCDN (ä¸»è¦)
                'https://registry.npmmirror.com/echarts/5.4.3/files/dist/echarts.min.js', // é˜¿é‡Œäº‘é•œåƒ (å¤‡ç”¨1)
                'https://cdn.staticfile.org/echarts/5.4.3/echarts.min.js'                // ä¸ƒç‰›äº‘ (å¤‡ç”¨2)
            ];
            
            let currentIndex = 0; // å½“å‰å°è¯•çš„CDNç´¢å¼•
            
            /**
             * å°è¯•åŠ è½½è„šæœ¬å‡½æ•°
             * é€’å½’è°ƒç”¨ï¼Œç›´åˆ°æˆåŠŸåŠ è½½æˆ–æ‰€æœ‰CDNéƒ½å¤±è´¥
             */
            function tryLoadScript() {
                // å¦‚æœæ‰€æœ‰CDNéƒ½å°è¯•è¿‡äº†ï¼Œæ˜¾ç¤ºé”™è¯¯
                if (currentIndex >= cdnList.length) {
                    console.error('æ‰€æœ‰ECharts CDNéƒ½æ— æ³•åŠ è½½');
                    return;
                }
                
                // åˆ›å»ºscriptæ ‡ç­¾åŠ¨æ€åŠ è½½
                const script = document.createElement('script');
                script.src = cdnList[currentIndex];
                
                // åŠ è½½æˆåŠŸå›è°ƒ
                script.onload = function() {
                    console.log('EChartsåŠ è½½æˆåŠŸ:', cdnList[currentIndex]);
                    console.log('EChartsç‰ˆæœ¬:', echarts.version);
                    initializeCharts(); // åˆå§‹åŒ–å›¾è¡¨
                };
                
                // æ·»åŠ æ§åˆ¶å°è°ƒè¯•ä¿¡æ¯
                window.onerror = function(msg, url, lineNo, columnNo, error) {
                    console.error('é¡µé¢é”™è¯¯:', msg);
                    console.error('é”™è¯¯ä½ç½®:', url, 'è¡Œ:', lineNo, 'åˆ—:', columnNo);
                    console.error('é”™è¯¯è¯¦æƒ…:', error);
                    return false;
                };
                
                // åŠ è½½å¤±è´¥å›è°ƒï¼Œå°è¯•ä¸‹ä¸€ä¸ªCDN
                script.onerror = function() {
                    console.log('CDNåŠ è½½å¤±è´¥:', cdnList[currentIndex]);
                    currentIndex++;
                    tryLoadScript(); // é€’å½’å°è¯•ä¸‹ä¸€ä¸ªCDN
                };
                
                // å°†scriptæ ‡ç­¾æ·»åŠ åˆ°é¡µé¢å¤´éƒ¨
                document.head.appendChild(script);
            }
            
            tryLoadScript(); // å¼€å§‹å°è¯•åŠ è½½
        }
        
        // é¡µé¢DOMåŠ è½½å®Œæˆåå¼€å§‹åŠ è½½EChartsåº“
        document.addEventListener('DOMContentLoaded', loadECharts);
    </script>
    <!-- ========== é¡µé¢æ ·å¼å®šä¹‰ ========== -->
    <style>
        /* ========== å…¨å±€æ ·å¼é‡ç½®å’ŒåŸºç¡€è®¾ç½® ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* ç¡®ä¿paddingå’ŒborderåŒ…å«åœ¨å…ƒç´ å®½åº¦å†… */
        }

        /* ========== é¡µé¢ä¸»ä½“æ ·å¼ ========== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* ç°ä»£åŒ–å­—ä½“æ ˆ */
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 50%, #69c0ff 100%); /* è“è‰²æ¸å˜èƒŒæ™¯ */
            min-height: 100vh; /* æœ€å°é«˜åº¦ä¸ºè§†çª—é«˜åº¦ */
            padding: 20px; /* é¡µé¢å†…è¾¹è· */
        }

        /* ========== ä¸»å®¹å™¨æ ·å¼ ========== */
        .container {
            max-width: 1400px; /* æœ€å¤§å®½åº¦é™åˆ¶ */
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
            background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            border-radius: 20px; /* åœ†è§’è¾¹æ¡† */
            box-shadow: 0 20px 40px rgba(24, 144, 255, 0.2); /* è“è‰²é˜´å½±æ•ˆæœ */
            overflow: hidden; /* éšè—æº¢å‡ºå†…å®¹ */
            border: 2px solid rgba(24, 144, 255, 0.3); /* è“è‰²è¾¹æ¡† */
        }

        /* ========== é¡µé¢æ ‡é¢˜æ ·å¼ ========== */
        .header {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 50%, #0050b3 100%); /* è“è‰²æ¸å˜èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            padding: 30px; /* å†…è¾¹è· */
            position: relative; /* ç›¸å¯¹å®šä½ */
        }

        .header h1 {
            font-size: 2.5em; /* å¤§æ ‡é¢˜å­—ä½“å¤§å° */
            margin-bottom: 10px; /* ä¸‹è¾¹è· */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* æ–‡å­—é˜´å½± */
        }

        .header p {
            font-size: 1.1em; /* å‰¯æ ‡é¢˜å­—ä½“å¤§å° */
            opacity: 0.9; /* é€æ˜åº¦ */
        }

        /* ========== æ§åˆ¶é¢æ¿æ ·å¼ ========== */
        .controls {
            background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); /* æµ…è“è‰²æ¸å˜èƒŒæ™¯ */
            padding: 20px; /* å†…è¾¹è· */
            border-bottom: 1px solid #40a9ff; /* è“è‰²åº•éƒ¨è¾¹æ¡† */
            display: flex; /* å¼¹æ€§å¸ƒå±€ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            gap: 20px; /* å…ƒç´ é—´è· */
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .btn {
            padding: 12px 24px; /* å†…è¾¹è· */
            border: none; /* æ— è¾¹æ¡† */
            border-radius: 25px; /* åœ†è§’ */
            cursor: pointer; /* é¼ æ ‡æŒ‡é’ˆ */
            font-size: 14px; /* å­—ä½“å¤§å° */
            font-weight: 600; /* å­—ä½“ç²—ç»† */
            transition: all 0.3s ease; /* è¿‡æ¸¡åŠ¨ç”» */
            text-transform: uppercase; /* å¤§å†™å­—æ¯ */
            letter-spacing: 0.5px; /* å­—æ¯é—´è· */
        }

        /* ä¸»è¦æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%); /* è“è‰²æ¸å˜èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            border: 2px solid #0050b3; /* æ·±è“è‰²è¾¹æ¡† */
        }

        .btn-primary:hover {
            transform: translateY(-2px); /* æ‚¬åœä¸Šç§»æ•ˆæœ */
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.4); /* è“è‰²æ‚¬åœé˜´å½± */
            background: linear-gradient(135deg, #0050b3 0%, #1890ff 100%); /* æ‚¬åœæ—¶åè½¬æ¸å˜ */
        }

        /* æˆåŠŸæŒ‰é’®æ ·å¼ */
        .btn-success {
            background: linear-gradient(135deg, #1890ff 0%, #69c0ff 100%); /* æµ…è“è‰²æ¸å˜ */
            color: white;
            border: 2px solid #40a9ff; /* è“è‰²è¾¹æ¡† */
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 169, 255, 0.4);
            background: linear-gradient(135deg, #40a9ff 0%, #1890ff 100%);
        }

        /* å±é™©æŒ‰é’®æ ·å¼ */
        .btn-danger {
            background: linear-gradient(135deg, #0050b3 0%, #003a8c 100%); /* æ·±è“è‰²æ¸å˜ */
            color: white;
            border: 2px solid #002766; /* æ›´æ·±è“è‰²è¾¹æ¡† */
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 80, 179, 0.4);
            background: linear-gradient(135deg, #003a8c 0%, #0050b3 100%);
        }

        /* ========== çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ ========== */
        .status {
            display: flex; /* å¼¹æ€§å¸ƒå±€ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            gap: 10px; /* å…ƒç´ é—´è· */
            padding: 10px 20px; /* å†…è¾¹è· */
            border-radius: 20px; /* åœ†è§’ */
            font-weight: 600; /* å­—ä½“ç²—ç»† */
            font-size: 14px; /* å­—ä½“å¤§å° */
        }

        /* çŠ¶æ€æŒ‡ç¤ºç¯æ ·å¼ */
        .status-indicator {
            width: 12px; /* å®½åº¦ */
            height: 12px; /* é«˜åº¦ */
            border-radius: 50%; /* åœ†å½¢ */
            animation: pulse 2s infinite; /* è„‰å†²åŠ¨ç”» */
        }

        /* è¿è¡ŒçŠ¶æ€æ ·å¼ */
        .status.running {
            background: rgba(24, 144, 255, 0.1); /* æµ…è“è‰²èƒŒæ™¯ */
            color: #1890ff; /* è“è‰²æ–‡å­— */
            border: 1px solid rgba(24, 144, 255, 0.3); /* è“è‰²è¾¹æ¡† */
        }

        .status.running .status-indicator {
            background: #1890ff; /* è“è‰²æŒ‡ç¤ºç¯ */
        }

        /* åœæ­¢çŠ¶æ€æ ·å¼ */
        .status.stopped {
            background: rgba(0, 80, 179, 0.1); /* æ·±è“è‰²èƒŒæ™¯ */
            color: #0050b3; /* æ·±è“è‰²æ–‡å­— */
            border: 1px solid rgba(0, 80, 179, 0.3); /* æ·±è“è‰²è¾¹æ¡† */
        }

        .status.stopped .status-indicator {
            background: #0050b3; /* æ·±è“è‰²æŒ‡ç¤ºç¯ */
            animation: none; /* æ— åŠ¨ç”» */
        }

        /* ========== è„‰å†²åŠ¨ç”»å®šä¹‰ ========== */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(24, 144, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(24, 144, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(24, 144, 255, 0);
            }
        }

        /* ========== å›¾è¡¨ç½‘æ ¼å¸ƒå±€ ========== */
        /* ä½¿ç”¨CSS Gridåˆ›å»ºå“åº”å¼çš„å›¾è¡¨å¸ƒå±€ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* è‡ªé€‚åº”åˆ—æ•°ï¼Œæœ€å°å®½åº¦400px */
            gap: 20px; /* å›¾è¡¨é—´è· */
            padding: 20px;
            max-width: 1400px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            margin: 0 auto; /* å±…ä¸­æ˜¾ç¤º */
        }

        /* ========== å•ä¸ªå›¾è¡¨å®¹å™¨æ ·å¼ ========== */
        .chart-container {
            background: white; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 15px; /* åœ†è§’ */
            box-shadow: 0 5px 15px rgba(24, 144, 255, 0.15); /* è“è‰²é˜´å½± */
            overflow: hidden; /* éšè—æº¢å‡º */
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* è¿‡æ¸¡åŠ¨ç”» */
            border: 2px solid rgba(24, 144, 255, 0.2); /* è“è‰²è¾¹æ¡† */
        }

        .chart-container:hover {
            transform: translateY(-5px); /* æ‚¬åœä¸Šç§» */
            box-shadow: 0 10px 25px rgba(24, 144, 255, 0.25); /* è“è‰²æ‚¬åœé˜´å½± */
            border-color: rgba(24, 144, 255, 0.4); /* æ‚¬åœæ—¶åŠ æ·±è¾¹æ¡† */
        }

        /* ========== å›¾è¡¨æ ‡é¢˜æ ·å¼ ========== */
        .chart-title {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 50%, #69c0ff 100%); /* è“è‰²æ¸å˜èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            padding: 15px 20px; /* å†…è¾¹è· */
            font-size: 1.2em; /* å­—ä½“å¤§å° */
            font-weight: 600; /* å­—ä½“ç²—ç»† */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* æ–‡å­—é˜´å½± */
        }

        /* ========== å›¾è¡¨å†…å®¹åŒºåŸŸæ ·å¼ ========== */
        .chart {
            width: 100%; /* å…¨å®½ */
            height: 400px; /* å›ºå®šé«˜åº¦ */
            padding: 10px; /* å†…è¾¹è· */
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        /* å¹³æ¿è®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr; /* å•åˆ—å¸ƒå±€ */
                gap: 15px; /* å‡å°é—´è· */
                padding: 15px; /* å‡å°å†…è¾¹è· */
            }
            
            .chart {
                height: 300px; /* å‡å°å›¾è¡¨é«˜åº¦ */
            }
            
            .controls {
                flex-direction: column; /* å‚ç›´æ’åˆ— */
                gap: 15px; /* å‡å°é—´è· */
            }
            
            .header h1 {
                font-size: 2em; /* å‡å°æ ‡é¢˜å­—ä½“ */
            }
        }

        /* æ‰‹æœºè®¾å¤‡é€‚é… */
        @media (max-width: 480px) {
            body {
                padding: 10px; /* å‡å°é¡µé¢è¾¹è· */
            }
            
            .chart {
                height: 250px; /* è¿›ä¸€æ­¥å‡å°å›¾è¡¨é«˜åº¦ */
            }
            
            .btn {
                padding: 10px 20px; /* å‡å°æŒ‰é’®å†…è¾¹è· */
                font-size: 12px; /* å‡å°æŒ‰é’®å­—ä½“ */
            }
            
            .header {
                padding: 20px; /* å‡å°æ ‡é¢˜å†…è¾¹è· */
            }
            
            .header h1 {
                font-size: 1.8em; /* è¿›ä¸€æ­¥å‡å°æ ‡é¢˜å­—ä½“ */
            }
        }
    </style>
</head>
<body>
    <!-- ========== ä¸»å®¹å™¨ ========== -->
    <!-- åŒ…å«æ•´ä¸ªé¡µé¢çš„æ‰€æœ‰å†…å®¹ï¼Œæä¾›ç»Ÿä¸€çš„æ ·å¼å’Œå¸ƒå±€ -->
    <div class="container">
        <!-- ========== é¡µé¢å¤´éƒ¨ ========== -->
        <!-- æ˜¾ç¤ºé¡µé¢æ ‡é¢˜å’Œæè¿°ä¿¡æ¯ -->
        <div class="header">
            <h1>ğŸ”µ åŠ¨ç‰©è¯†åˆ«å®æ—¶å›¾è¡¨ç³»ç»Ÿ</h1>
            <p>åŸºäºå›¾åƒå›ä¼ æ•°æ®çš„å¤šç»´åº¦å¯è§†åŒ–åˆ†æç³»ç»Ÿ - è“è‰²ä¸»é¢˜ç‰ˆ</p>
        </div>

        <!-- ========== æ§åˆ¶é¢æ¿ ========== -->
        <!-- æä¾›å›¾è¡¨æ§åˆ¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯åŠ¨/åœæ­¢å®æ—¶æ›´æ–°å’Œæ‰‹åŠ¨åˆ·æ–° -->
        <div class="controls">
            <!-- å¼€å§‹å®æ—¶æ›´æ–°æŒ‰é’® -->
            <button class="btn btn-success" onclick="startRealTimeUpdate()">
                â–¶ï¸ å¼€å§‹å®æ—¶æ›´æ–°
            </button>
            
            <!-- åœæ­¢å®æ—¶æ›´æ–°æŒ‰é’® -->
            <button class="btn btn-danger" onclick="stopRealTimeUpdate()">
                â¹ï¸ åœæ­¢å®æ—¶æ›´æ–°
            </button>
            
            <!-- æ‰‹åŠ¨åˆ·æ–°æ•°æ®æŒ‰é’® -->
            <button class="btn btn-primary" onclick="refreshAllCharts()">
                ğŸ”„ åˆ·æ–°æ•°æ®
            </button>
            
            <!-- å®æ—¶æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="status stopped" id="updateStatus">
                <div class="status-indicator"></div>
                <span>å®æ—¶æ›´æ–°å·²åœæ­¢</span>
            </div>
        </div>

        <!-- ========== å›¾è¡¨å±•ç¤ºåŒºåŸŸ ========== -->
        <!-- ä½¿ç”¨ç½‘æ ¼å¸ƒå±€å±•ç¤ºä¸‰ä¸ªæ ¸å¿ƒå›¾è¡¨ï¼Œæ”¯æŒå“åº”å¼è®¾è®¡ -->
        <div class="charts-grid">
            <!-- ========== å›¾è¡¨1ï¼šæŒ‰æ—¥æœŸç»Ÿè®¡çš„å›¾åƒè¯†åˆ«æ•°é‡å˜åŒ–è¶‹åŠ¿ ========== -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ æŒ‰æ—¥æœŸç»Ÿè®¡çš„å›¾åƒè¯†åˆ«æ•°é‡å˜åŒ–è¶‹åŠ¿</div>
                <div id="timeseriesChart" class="chart"></div>
            </div>

            <!-- ========== å›¾è¡¨2ï¼šä¸åŒåŠ¨ç‰©ç§ç±»çš„è¯†åˆ«æ•°é‡åˆ†å¸ƒæƒ…å†µ ========== -->
            <div class="chart-container">
                <div class="chart-title">ğŸ¦ ä¸åŒåŠ¨ç‰©ç§ç±»çš„è¯†åˆ«æ•°é‡åˆ†å¸ƒæƒ…å†µ</div>
                <div id="animalChart" class="chart"></div>
            </div>

            <!-- ========== å›¾è¡¨3ï¼šä¸åŒåœ°ç†ä½ç½®åŠ¨ç‰©è¯†åˆ«æ•°é‡åˆ†å¸ƒæƒ…å†µ ========== -->
            <div class="chart-container">
                <div class="chart-title">ğŸŒ ä¸åŒåœ°ç†ä½ç½®åŠ¨ç‰©è¯†åˆ«æ•°é‡åˆ†å¸ƒæƒ…å†µ</div>
                <div id="locationChart" class="chart"></div>
            </div>
        </div>
    </div>

    <!-- ========== JavaScript æ ¸å¿ƒåŠŸèƒ½å®ç° ========== -->
    <script>
        // ========== å…¨å±€å˜é‡å®šä¹‰ ========== 
        // å­˜å‚¨æ‰€æœ‰å›¾è¡¨å®ä¾‹ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†å’Œæ›´æ–°
        let chartInstances = {
            timeseriesChart: null,  // æ—¶é—´åºåˆ—è¶‹åŠ¿å›¾å®ä¾‹
            animalChart: null,      // åŠ¨ç‰©ç§ç±»åˆ†å¸ƒå›¾å®ä¾‹
            locationChart: null     // åœ°ç†ä½ç½®åˆ†å¸ƒå›¾å®ä¾‹
        };
        
        // å®æ—¶æ›´æ–°å®šæ—¶å™¨ï¼Œç”¨äºæ§åˆ¶æ•°æ®åˆ·æ–°é¢‘ç‡
        let updateTimer = null;
        
        // å®æ—¶æ›´æ–°çŠ¶æ€æ ‡è¯†ï¼Œé˜²æ­¢é‡å¤å¯åŠ¨
        let isRealTimeActive = false;

        /**
         * ========== å›¾è¡¨åˆå§‹åŒ–ä¸»å‡½æ•° ==========
         * åŠŸèƒ½ï¼šåœ¨EChartsåº“åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
         * è°ƒç”¨æ—¶æœºï¼šEChartsåº“åŠ¨æ€åŠ è½½æˆåŠŸå
         * ä½œç”¨ï¼šåˆ›å»ºå›¾è¡¨å®ä¾‹ã€è®¾ç½®åˆå§‹é…ç½®ã€åŠ è½½åˆå§‹æ•°æ®
         */
        function initializeCharts() {
            console.log('å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');
            
            // æ£€æŸ¥EChartsæ˜¯å¦å·²åŠ è½½
            if (typeof echarts === 'undefined') {
                console.error('EChartsåº“æœªåŠ è½½');
                return;
            }

            try {
                // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨å®ä¾‹
                initializeTimeseriesChart(); // æŒ‰æ—¥æœŸç»Ÿè®¡çš„å›¾åƒè¯†åˆ«æ•°é‡å˜åŒ–è¶‹åŠ¿å›¾
                initializeAnimalChart();     // åŠ¨ç‰©ç§ç±»åˆ†å¸ƒå›¾
                initializeLocationChart();   // åœ°ç†ä½ç½®åˆ†å¸ƒå›¾
                
                // åŠ è½½æ‰€æœ‰å›¾è¡¨çš„åˆå§‹æ•°æ®
                loadAllChartsData();
                
                console.log('æ‰€æœ‰å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        /**
         * ========== æŒ‰æ—¥æœŸç»Ÿè®¡çš„å›¾åƒè¯†åˆ«æ•°é‡å˜åŒ–è¶‹åŠ¿å›¾åˆå§‹åŒ– ==========
         * åŠŸèƒ½ï¼šåˆ›å»ºæ˜¾ç¤ºæŒ‰æ—¥æœŸç»Ÿè®¡çš„å›¾åƒè¯†åˆ«æ•°é‡å˜åŒ–è¶‹åŠ¿çš„æŠ˜çº¿å›¾
         * å›¾è¡¨ç±»å‹ï¼šæŠ˜çº¿å›¾
         * æ•°æ®ç»´åº¦ï¼šæ—¥æœŸ vs è¯†åˆ«æ•°é‡
         */
        function initializeTimeseriesChart() {
            const chartDom = document.getElementById('timeseriesChart');
            chartInstances.timeseriesChart = echarts.init(chartDom);
            
            // è®¾ç½®å›¾è¡¨åŸºç¡€é…ç½®
            const option = {
                title: {
                    text: 'æŒ‰æ—¥æœŸç»Ÿè®¡çš„å›¾åƒè¯†åˆ«æ•°é‡å˜åŒ–è¶‹åŠ¿',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1890ff'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>è¯†åˆ«æ•°é‡: ${params[0].value}`;
                    }
                },
                legend: {
                    data: ['è¯†åˆ«æ•°é‡'],
                    top: 30,
                    textStyle: {
                        color: '#1890ff'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: [], // å°†é€šè¿‡APIè·å–æ•°æ®
                    axisLabel: {
                        rotate: 45, // æ—‹è½¬æ ‡ç­¾é¿å…é‡å 
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'è¯†åˆ«æ•°é‡',
                    nameTextStyle: {
                        color: '#1890ff'
                    },
                    axisLabel: {
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                series: [{
                    name: 'è¯†åˆ«æ•°é‡',
                    type: 'line',
                    smooth: true, // å¹³æ»‘æ›²çº¿
                    data: [],
                    itemStyle: {
                        color: '#1890ff',
                        borderColor: '#1890ff',
                        borderWidth: 2
                    },
                    lineStyle: {
                        color: '#1890ff',
                        width: 3
                    },
                    areaStyle: { // æ·»åŠ é¢ç§¯å¡«å……
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: '#1890ff'
                            }, {
                                offset: 1, color: 'rgba(24, 144, 255, 0.1)'
                            }]
                        }
                    }
                }]
            };
            
            chartInstances.timeseriesChart.setOption(option);
        }

        /**
         * ========== åŠ¨ç‰©ç§ç±»åˆ†å¸ƒå›¾åˆå§‹åŒ– ==========
         * åŠŸèƒ½ï¼šåˆ›å»ºæ˜¾ç¤ºä¸åŒåŠ¨ç‰©ç§ç±»è¯†åˆ«æ•°é‡åˆ†å¸ƒçš„é¥¼å›¾
         * å›¾è¡¨ç±»å‹ï¼šé¥¼å›¾
         * æ•°æ®ç»´åº¦ï¼šåŠ¨ç‰©ç§ç±» vs è¯†åˆ«æ•°é‡
         */
        function initializeAnimalChart() {
            // é€šè¿‡ getElementById è·å– ID ä¸º animalChart çš„ HTML å…ƒç´ ï¼ˆä¾‹å¦‚ä¸€ä¸ª < div >ï¼‰
            const chartDom = document.getElementById('animalChart');
            // ä½¿ç”¨ echarts.init() åˆå§‹åŒ–è¿™ä¸ªå›¾è¡¨å®¹å™¨ï¼Œå¹¶ä¿å­˜åˆ° chartInstances.animalChart ä¸­
            //ï¼ˆchartInstances å¯èƒ½æ˜¯å…¨å±€å¯¹è±¡ï¼Œç”¨äºä¿å­˜å¤šä¸ªå›¾è¡¨å®ä¾‹ï¼‰ã€‚
            chartInstances.animalChart = echarts.init(chartDom);
            
            // å›¾è¡¨é…ç½®é¡¹ option
            const option = {
                title: { //æ ‡é¢˜
                    text: 'ä¸åŒåŠ¨ç‰©ç§ç±»çš„è¯†åˆ«æ•°é‡åˆ†å¸ƒæƒ…å†µ',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1890ff'
                    }
                },
                tooltip: { //æç¤ºæ¡†
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: { //å›¾ä¾‹
                    orient: 'vertical',
                    left: 'left',
                    top: 'middle',
                    textStyle: {
                        color: '#1890ff'
                    }
                },
                color: [
                    '#1890ff',  // ä¸»è“è‰²
                    '#40a9ff',  // äº®è“è‰²
                    '#69c0ff',  // æµ…è“è‰²
                    '#91d5ff',  // æ›´æµ…è“è‰²
                    '#bae7ff',  // æ·¡è“è‰²
                    '#e6f7ff',  // ææ·¡è“è‰²
                    '#0050b3',  // æ·±è“è‰²
                    '#003a8c'   // æ›´æ·±è“è‰²
                ],
                // æ•°æ®
                series: [{
                    name: 'åŠ¨ç‰©ç§ç±»',
                    type: 'pie',
                    radius: ['40%', '70%'], // ç¯å½¢é¥¼å›¾
                    center: ['60%', '50%'],
                    data: [],  // åˆå§‹æ•°æ®ä¸ºç©ºï¼Œåç»­å¯èƒ½é€šè¿‡æ¥å£æˆ–å‡½æ•°åŠ¨æ€è®¾ç½®
                    emphasis: {  // é«˜äº®æ ·å¼ï¼ˆé¼ æ ‡æ‚¬åœæ—¶ï¼‰
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(24, 144, 255, 0.5)'
                        }
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {d}%',
                        color: '#1890ff'
                    },
                    labelLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                }]
            };
            // åº”ç”¨é…ç½®
            chartInstances.animalChart.setOption(option);
        }

        /**
         * ========== åœ°ç†ä½ç½®åˆ†å¸ƒå›¾åˆå§‹åŒ– ==========
         * åŠŸèƒ½ï¼šåˆ›å»ºæ˜¾ç¤ºä¸åŒåœ°ç†ä½ç½®åŠ¨ç‰©è¯†åˆ«æ•°é‡åˆ†å¸ƒçš„æŸ±çŠ¶å›¾
         * å›¾è¡¨ç±»å‹ï¼šæŸ±çŠ¶å›¾
         * æ•°æ®ç»´åº¦ï¼šåœ°ç†ä½ç½® vs è¯†åˆ«æ•°é‡
         */
        function initializeLocationChart() {
            const chartDom = document.getElementById('locationChart');
            chartInstances.locationChart = echarts.init(chartDom);
            
            const option = {
                title: {
                    text: 'ä¸åŒåœ°ç†ä½ç½®åŠ¨ç‰©è¯†åˆ«æ•°é‡åˆ†å¸ƒæƒ…å†µ',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1890ff'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>è¯†åˆ«æ•°é‡: ${params[0].value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    name: 'åœ°ç†ä½ç½®',
                    nameTextStyle: {
                        color: '#1890ff'
                    },
                    axisLabel: {
                        interval: 0,
                        rotate: 45,
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'è¯†åˆ«æ•°é‡',
                    nameTextStyle: {
                        color: '#1890ff'
                    },
                    axisLabel: {
                        color: '#1890ff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#1890ff'
                        }
                    }
                },
                series: [{
                    name: 'è¯†åˆ«æ•°é‡',
                    type: 'bar',
                    data: [],
                    itemStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: '#1890ff'
                            }, {
                                offset: 1, color: '#40a9ff'
                            }]
                        },
                        borderColor: '#1890ff',
                        borderWidth: 2
                    },
                    emphasis: {
                        itemStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: '#0050b3'
                                }, {
                                    offset: 1, color: '#1890ff'
                                }]
                            }
                        }
                    }
                }]
            };
            
            chartInstances.locationChart.setOption(option);
        }

        /**
         * ========== æ•°æ®è·å–å’Œæ›´æ–°å‡½æ•° ==========
         */

        /**
         * åŠ è½½æ‰€æœ‰å›¾è¡¨æ•°æ®
         * åŠŸèƒ½ï¼šå¹¶è¡Œè·å–æ‰€æœ‰å›¾è¡¨çš„æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
         */
        async function loadAllChartsData() {
            console.log('å¼€å§‹åŠ è½½å›¾è¡¨æ•°æ®...');
            
            try {
                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®ï¼Œæé«˜åŠ è½½æ•ˆç‡
                await Promise.all([
                    loadTimeseriesData(),
                    loadAnimalData(), 
                    loadLocationData()
                ]);
                
                console.log('æ‰€æœ‰å›¾è¡¨æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            }
        }

        /**
         * è·å–æ—¶é—´åºåˆ—æ•°æ®
         * APIæ¥å£ï¼š/api/timeseries-data
         * è¿”å›æ ¼å¼ï¼š[{date: "2024-01-01", count: 10, confidence: 0.95, percentage: 85.5}]
         */
        async function loadTimeseriesData() {
            try {
                const response = await fetch('/api/timeseries-data');
                const data = await response.json();
                
                if (data && data.status === 'success' && Array.isArray(data.data) && chartInstances.timeseriesChart) {
                    const dates = data.data.map(item => item.date);
                    const counts = data.data.map(item => item.count);
                    
                    chartInstances.timeseriesChart.setOption({
                        xAxis: {
                            data: dates
                        },
                        series: [{
                            data: counts
                        }]
                    });
                }
            } catch (error) {
                console.error('æ—¶é—´åºåˆ—æ•°æ®è·å–å¤±è´¥:', error);
            }
        }

        /**
         * è·å–åŠ¨ç‰©ç§ç±»åˆ†å¸ƒæ•°æ®
         * APIæ¥å£ï¼š/api/chart-data
         * è¿”å›æ ¼å¼ï¼š[{animal: "ç‹®å­", count: 25}]
         */
        async function loadAnimalData() {
            try {
                // è¯·æ±‚æ•°æ®å¹¶è§£æ
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                
                // data ä¸ä¸ºç©ºï¼›data æ˜¯ä¸€ä¸ªæ•°ç»„ï¼›chartInstances.animalChartï¼ˆå‰é¢åˆå§‹åŒ–å¥½çš„ ECharts å®ä¾‹ï¼‰å·²å­˜åœ¨ã€‚
                if (data && data.status === 'success' && Array.isArray(data.data) && chartInstances.animalChart) {
                    const pieData = data.data.map(item => ({  // å°†åç«¯æ ¼å¼è½¬æˆ ECharts é¥¼å›¾éœ€è¦çš„æ ¼å¼
                        name: item.animal,
                        value: item.count
                    }));
                    
                    // è°ƒç”¨ ECharts å®ä¾‹çš„ setOption æ–¹æ³•ï¼Œå‘ç¬¬ä¸€ä¸ª seriesï¼ˆé¥¼å›¾ç³»åˆ—ï¼‰æ³¨å…¥æ–°çš„ dataã€‚
                    chartInstances.animalChart.setOption({
                        series: [{
                            data: pieData
                        }]
                    });
                }
            } catch (error) {
                console.error('åŠ¨ç‰©æ•°æ®è·å–å¤±è´¥:', error);
            }
        }

        /**
         * è·å–åœ°ç†ä½ç½®åˆ†å¸ƒæ•°æ®
         * APIæ¥å£ï¼š/api/location-data
         * è¿”å›æ ¼å¼ï¼š[{location: "åŒ—äº¬", count: 15}]
         */
        async function loadLocationData() {
            try {
                const response = await fetch('/api/location-data');
                const data = await response.json();
                
                if (data && data.status === 'success' && Array.isArray(data.data) && chartInstances.locationChart) {
                    const locations = data.data.map(item => item.location);
                    const counts = data.data.map(item => item.count);
                    
                    chartInstances.locationChart.setOption({
                        xAxis: {
                            data: locations
                        },
                        series: [{
                            data: counts
                        }]
                    });
                }
            } catch (error) {
                console.error('åœ°ç†ä½ç½®æ•°æ®è·å–å¤±è´¥:', error);
            }
        }

        /**
         * ========== å®æ—¶æ›´æ–°æ§åˆ¶å‡½æ•° ==========
         */

        /**
         * å¼€å§‹å®æ—¶æ›´æ–°
         * åŠŸèƒ½ï¼šå¯åŠ¨å®šæ—¶å™¨ï¼Œå®šæœŸåˆ·æ–°å›¾è¡¨æ•°æ®
         * æ›´æ–°é¢‘ç‡ï¼š3ç§’ä¸€æ¬¡
         */
        function startRealTimeUpdate() {
            if (isRealTimeActive) {
                console.log('å®æ—¶æ›´æ–°å·²åœ¨è¿è¡Œä¸­');
                return;
            }
            
            isRealTimeActive = true;
            updateTimer = setInterval(loadAllChartsData, 3000); // 3ç§’æ›´æ–°ä¸€æ¬¡
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatusDisplay(true);
            console.log('å®æ—¶æ›´æ–°å·²å¯åŠ¨');
        }

        /**
         * åœæ­¢å®æ—¶æ›´æ–°
         * åŠŸèƒ½ï¼šæ¸…é™¤å®šæ—¶å™¨ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
         */
        function stopRealTimeUpdate() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
            
            isRealTimeActive = false;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatusDisplay(false);
            console.log('å®æ—¶æ›´æ–°å·²åœæ­¢');
        }

        /**
         * æ‰‹åŠ¨åˆ·æ–°æ‰€æœ‰å›¾è¡¨
         * åŠŸèƒ½ï¼šç«‹å³æ›´æ–°æ‰€æœ‰å›¾è¡¨æ•°æ®ï¼Œä¸å½±å“å®æ—¶æ›´æ–°çŠ¶æ€
         */
        function refreshAllCharts() {
            console.log('æ‰‹åŠ¨åˆ·æ–°å›¾è¡¨æ•°æ®');
            loadAllChartsData();
        }

        /**
         * æ›´æ–°çŠ¶æ€æ˜¾ç¤º
         * åŠŸèƒ½ï¼šæ›´æ–°é¡µé¢ä¸Šçš„å®æ—¶æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
         * @param {boolean} isRunning - æ˜¯å¦æ­£åœ¨è¿è¡Œ
         */
        function updateStatusDisplay(isRunning) {
            const statusElement = document.getElementById('updateStatus');
            const statusText = statusElement.querySelector('span');
            
            if (isRunning) {
                statusElement.className = 'status running';
                statusText.textContent = 'å®æ—¶æ›´æ–°è¿è¡Œä¸­';
            } else {
                statusElement.className = 'status stopped';
                statusText.textContent = 'å®æ—¶æ›´æ–°å·²åœæ­¢';
            }
        }

        /**
         * ========== çª—å£å¤§å°å˜åŒ–å¤„ç† ==========
         * åŠŸèƒ½ï¼šå½“æµè§ˆå™¨çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨è°ƒæ•´å›¾è¡¨å°ºå¯¸
         */
        window.addEventListener('resize', function() {
            // éå†æ‰€æœ‰å›¾è¡¨å®ä¾‹ï¼Œè°ƒç”¨resizeæ–¹æ³•é‡æ–°è®¡ç®—å°ºå¯¸
            if (chartInstances.timeseriesChart) chartInstances.timeseriesChart.resize();
            if (chartInstances.animalChart) chartInstances.animalChart.resize();
            if (chartInstances.locationChart) chartInstances.locationChart.resize();
        });

        /**
          * ========== é¡µé¢å¸è½½å¤„ç† ==========
          * é¡µé¢å…³é—­æˆ–åˆ·æ–°æ—¶ï¼Œæ¸…ç†èµ„æºå’Œåœæ­¢å®šæ—¶å™¨
          */
         window.addEventListener('beforeunload', function() {
             // åœæ­¢å®æ—¶æ›´æ–°
             stopRealTimeUpdate();
             
             // é”€æ¯æ‰€æœ‰å›¾è¡¨å®ä¾‹ï¼Œé‡Šæ”¾å†…å­˜
             if (chartInstances.timeseriesChart) {
                 chartInstances.timeseriesChart.dispose();
             }
             if (chartInstances.animalChart) {
                 chartInstances.animalChart.dispose();
             }
             if (chartInstances.locationChart) {
                 chartInstances.locationChart.dispose();
             }
         });
    </script>
</body>
</html>