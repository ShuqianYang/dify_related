<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨ç‰©ç§ç±»åˆ†å¸ƒçƒ­åŠ›å›¾ç³»ç»Ÿ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Heatmap Plugin CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .control-panel {
            margin-bottom: 25px;
        }

        .control-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stats-panel {
            margin-top: 25px;
        }

        .stats-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .stats-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .stats-item p {
            color: #7f8c8d;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .animal-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .animal-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .animal-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .animal-item.selected {
            background: #3498db;
            color: white;
        }

        .animal-item strong {
            display: block;
            margin-bottom: 5px;
        }

        .animal-item small {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .map-container {
                height: 400px;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ åŠ¨ç‰©ç§ç±»åˆ†å¸ƒçƒ­åŠ›å›¾ç³»ç»Ÿ</h1>
        <p>åŸºäºæ‘„åƒå¤´ç›‘æµ‹æ•°æ®çš„åŠ¨ç‰©åˆ†å¸ƒå¯è§†åŒ–åˆ†æå¹³å°</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <h3>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h3>
                
                <div class="filter-group">
                    <label for="animalFilter">é€‰æ‹©åŠ¨ç‰©ç§ç±»:</label>
                    <select id="animalFilter">
                        <option value="">æ‰€æœ‰åŠ¨ç‰©</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="heatmapIntensity">çƒ­åŠ›å›¾å¼ºåº¦:</label>
                    <input type="range" id="heatmapIntensity" min="0.1" max="2" step="0.1" value="1">
                    <span id="intensityValue">1.0</span>
                </div>

                <div class="filter-group">
                    <label for="heatmapRadius">çƒ­åŠ›å›¾åŠå¾„:</label>
                    <input type="range" id="heatmapRadius" min="10" max="50" step="5" value="25">
                    <span id="radiusValue">25px</span>
                </div>

                <button class="btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn secondary" onclick="resetView()">ğŸ¯ é‡ç½®è§†å›¾</button>
                <button class="btn danger" onclick="clearHeatmap()">ğŸ§¹ æ¸…é™¤çƒ­åŠ›å›¾</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-panel">
                <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                <div id="statsContainer">
                    <div class="loading">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</div>
                </div>
            </div>

            <!-- åŠ¨ç‰©åˆ—è¡¨ -->
            <div class="stats-panel">
                <h3>ğŸ¾ åŠ¨ç‰©ç§ç±»åˆ—è¡¨</h3>
                <div id="animalList" class="animal-list">
                    <div class="loading">æ­£åœ¨åŠ è½½åŠ¨ç‰©æ•°æ®...</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <!-- å›¾ä¾‹ -->
            <div class="legend">
                <h4>å›¾ä¾‹è¯´æ˜</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: red;"></div>
                    <span>é«˜å¯†åº¦åŒºåŸŸ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: yellow;"></div>
                    <span>ä¸­å¯†åº¦åŒºåŸŸ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: blue;"></div>
                    <span>ä½å¯†åº¦åŒºåŸŸ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>æ‘„åƒå¤´ä½ç½®</span>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let map;
        let heatmapLayer;
        let markersLayer;
        let currentAnimal = '';
        let allHeatmapData = [];
        let allSensorData = [];
        let allAnimalStats = [];

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // åˆ›å»ºåœ°å›¾å®ä¾‹ - ä»¥ä¸­å›½ä¸ºä¸­å¿ƒ
            map = L.map('map').setView([35.0, 105.0], 5);

            // æ·»åŠ åœ°å›¾å›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // åˆ›å»ºå›¾å±‚ç»„
            markersLayer = L.layerGroup().addTo(map);

            console.log('ğŸ—ºï¸ åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        }

        // åŠ è½½çƒ­åŠ›å›¾æ•°æ®
        async function loadHeatmapData(animalFilter = '') {
            try {
                const url = animalFilter ? 
                    `/api/heatmap-by-animal/${encodeURIComponent(animalFilter)}` : 
                    '/api/heatmap-data';
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success') {
                    allHeatmapData = result.data;
                    updateHeatmap();
                    console.log(`ğŸ“Š åŠ è½½äº† ${result.count} æ¡çƒ­åŠ›å›¾æ•°æ®`);
                } else {
                    console.error('âŒ åŠ è½½çƒ­åŠ›å›¾æ•°æ®å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
            }
        }

        // åŠ è½½æ‘„åƒå¤´ä½ç½®æ•°æ®
        async function loadSensorData() {
            try {
                const response = await fetch('/api/sensor-locations');
                const result = await response.json();
                
                if (result.status === 'success') {
                    allSensorData = result.data;
                    updateSensorMarkers();
                    console.log(`ğŸ“ åŠ è½½äº† ${result.count} ä¸ªæ‘„åƒå¤´ä½ç½®`);
                } else {
                    console.error('âŒ åŠ è½½æ‘„åƒå¤´æ•°æ®å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
            }
        }

        // åŠ è½½åŠ¨ç‰©ç»Ÿè®¡æ•°æ®
        async function loadAnimalStats() {
            try {
                const response = await fetch('/api/animal-stats');
                const result = await response.json();
                
                if (result.status === 'success') {
                    allAnimalStats = result.data;
                    updateAnimalFilter();
                    updateAnimalList();
                    updateStatsPanel();
                    console.log(`ğŸ¾ åŠ è½½äº† ${result.count} ç§åŠ¨ç‰©ç»Ÿè®¡`);
                } else {
                    console.error('âŒ åŠ è½½åŠ¨ç‰©ç»Ÿè®¡å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
            }
        }

        // æ›´æ–°çƒ­åŠ›å›¾
        function updateHeatmap() {
            // ç§»é™¤ç°æœ‰çƒ­åŠ›å›¾
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }

            if (allHeatmapData.length === 0) {
                console.log('ğŸ“Š æ²¡æœ‰çƒ­åŠ›å›¾æ•°æ®');
                return;
            }

            // å‡†å¤‡çƒ­åŠ›å›¾æ•°æ®
            const heatData = allHeatmapData.map(item => [
                item.latitude,
                item.longitude,
                item.intensity * parseFloat(document.getElementById('heatmapIntensity').value)
            ]);

            // åˆ›å»ºçƒ­åŠ›å›¾å›¾å±‚
            heatmapLayer = L.heatLayer(heatData, {
                radius: parseInt(document.getElementById('heatmapRadius').value),
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.0: 'blue',
                    0.3: 'cyan',
                    0.5: 'lime',
                    0.7: 'yellow',
                    1.0: 'red'
                }
            }).addTo(map);

            console.log(`ğŸ”¥ æ›´æ–°çƒ­åŠ›å›¾: ${heatData.length} ä¸ªæ•°æ®ç‚¹`);
        }

        // æ›´æ–°æ‘„åƒå¤´æ ‡è®°
        function updateSensorMarkers() {
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            markersLayer.clearLayers();

            allSensorData.forEach(sensor => {
                const marker = L.circleMarker([sensor.latitude, sensor.longitude], {
                    radius: 8,
                    fillColor: '#3498db',
                    color: '#2980b9',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(`
                    <div style="font-family: Arial, sans-serif;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">ğŸ“¹ ${sensor.sensor_id}</h4>
                        <p style="margin: 5px 0;"><strong>ä½ç½®:</strong> ${sensor.location}</p>
                        <p style="margin: 5px 0;"><strong>æ£€æµ‹æ¬¡æ•°:</strong> ${sensor.total_detections}</p>
                        <p style="margin: 5px 0;"><strong>åæ ‡:</strong> ${sensor.latitude.toFixed(4)}, ${sensor.longitude.toFixed(4)}</p>
                    </div>
                `);

                markersLayer.addLayer(marker);
            });

            console.log(`ğŸ“ æ›´æ–°äº† ${allSensorData.length} ä¸ªæ‘„åƒå¤´æ ‡è®°`);
        }

        // æ›´æ–°åŠ¨ç‰©ç­›é€‰å™¨
        function updateAnimalFilter() {
            const select = document.getElementById('animalFilter');
            select.innerHTML = '<option value="">æ‰€æœ‰åŠ¨ç‰©</option>';
            
            allAnimalStats.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.animal_name;
                option.textContent = `${animal.animal_name} (${animal.count})`;
                select.appendChild(option);
            });
        }

        // æ›´æ–°åŠ¨ç‰©åˆ—è¡¨
        function updateAnimalList() {
            const container = document.getElementById('animalList');
            
            if (allAnimalStats.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— åŠ¨ç‰©æ•°æ®</div>';
                return;
            }

            container.innerHTML = allAnimalStats.map(animal => `
                <div class="animal-item" onclick="selectAnimal('${animal.animal_name}')" data-animal="${animal.animal_name}">
                    <strong>${animal.animal_name}</strong>
                    <small>æ£€æµ‹æ¬¡æ•°: ${animal.count} | æ‘„åƒå¤´: ${animal.sensor_count} | ç½®ä¿¡åº¦: ${animal.avg_confidence}%</small>
                </div>
            `).join('');
        }

        // æ›´æ–°ç»Ÿè®¡é¢æ¿
        function updateStatsPanel() {
            const container = document.getElementById('statsContainer');
            
            const totalDetections = allAnimalStats.reduce((sum, animal) => sum + animal.count, 0);
            const totalSensors = allSensorData.length;
            const totalAnimals = allAnimalStats.length;

            container.innerHTML = `
                <div class="stats-item">
                    <h4>ğŸ¯ æ€»æ£€æµ‹æ¬¡æ•°</h4>
                    <p>${totalDetections.toLocaleString()} æ¬¡</p>
                </div>
                <div class="stats-item">
                    <h4>ğŸ“¹ æ‘„åƒå¤´æ•°é‡</h4>
                    <p>${totalSensors} ä¸ª</p>
                </div>
                <div class="stats-item">
                    <h4>ğŸ¾ åŠ¨ç‰©ç§ç±»</h4>
                    <p>${totalAnimals} ç§</p>
                </div>
                <div class="stats-item">
                    <h4>ğŸ“Š å½“å‰ç­›é€‰</h4>
                    <p>${currentAnimal || 'æ‰€æœ‰åŠ¨ç‰©'}</p>
                </div>
            `;
        }

        // é€‰æ‹©åŠ¨ç‰©
        function selectAnimal(animalName) {
            currentAnimal = animalName;
            
            // æ›´æ–°UI
            document.getElementById('animalFilter').value = animalName;
            
            // æ›´æ–°åŠ¨ç‰©åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.animal-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-animal="${animalName}"]`)?.classList.add('selected');
            
            // é‡æ–°åŠ è½½çƒ­åŠ›å›¾æ•°æ®
            loadHeatmapData(animalName);
            updateStatsPanel();
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰æ•°æ®...');
            await Promise.all([
                loadHeatmapData(currentAnimal),
                loadSensorData(),
                loadAnimalStats()
            ]);
        }

        // é‡ç½®è§†å›¾
        function resetView() {
            map.setView([35.0, 105.0], 5);
            currentAnimal = '';
            document.getElementById('animalFilter').value = '';
            document.querySelectorAll('.animal-item').forEach(item => {
                item.classList.remove('selected');
            });
            loadHeatmapData();
            updateStatsPanel();
        }

        // æ¸…é™¤çƒ­åŠ›å›¾
        function clearHeatmap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('animalFilter').addEventListener('change', function() {
            selectAnimal(this.value);
        });

        document.getElementById('heatmapIntensity').addEventListener('input', function() {
            document.getElementById('intensityValue').textContent = this.value;
            updateHeatmap();
        });

        document.getElementById('heatmapRadius').addEventListener('input', function() {
            document.getElementById('radiusValue').textContent = this.value + 'px';
            updateHeatmap();
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            initMap();
            
            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿åœ°å›¾å®Œå…¨åˆå§‹åŒ–
            setTimeout(() => {
                refreshData();
            }, 1000);
        });

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', function() {
            if (map) {
                map.invalidateSize();
            }
        });
    </script>
</body>
</html>