<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动物种类分布热力图系统</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Heatmap Plugin CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .control-panel {
            margin-bottom: 25px;
        }

        .control-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stats-panel {
            margin-top: 25px;
        }

        .stats-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .stats-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .stats-item p {
            color: #7f8c8d;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .animal-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .animal-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .animal-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .animal-item.selected {
            background: #3498db;
            color: white;
        }

        .animal-item strong {
            display: block;
            margin-bottom: 5px;
        }

        .animal-item small {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .map-container {
                height: 400px;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🗺️ 动物种类分布热力图系统</h1>
        <p>基于摄像头监测数据的动物分布可视化分析平台</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <!-- 控制面板 -->
            <div class="control-panel">
                <h3>🎛️ 控制面板</h3>
                
                <div class="filter-group">
                    <label for="animalFilter">选择动物种类:</label>
                    <select id="animalFilter">
                        <option value="">所有动物</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="heatmapIntensity">热力图强度:</label>
                    <input type="range" id="heatmapIntensity" min="0.1" max="2" step="0.1" value="1">
                    <span id="intensityValue">1.0</span>
                </div>

                <div class="filter-group">
                    <label for="heatmapRadius">热力图半径:</label>
                    <input type="range" id="heatmapRadius" min="10" max="50" step="5" value="25">
                    <span id="radiusValue">25px</span>
                </div>

                <button class="btn" onclick="refreshData()">🔄 刷新数据</button>
                <button class="btn secondary" onclick="resetView()">🎯 重置视图</button>
                <button class="btn danger" onclick="clearHeatmap()">🧹 清除热力图</button>
            </div>

            <!-- 统计信息 -->
            <div class="stats-panel">
                <h3>📊 统计信息</h3>
                <div id="statsContainer">
                    <div class="loading">正在加载统计数据...</div>
                </div>
            </div>

            <!-- 动物列表 -->
            <div class="stats-panel">
                <h3>🐾 动物种类列表</h3>
                <div id="animalList" class="animal-list">
                    <div class="loading">正在加载动物数据...</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            
            <!-- 图例 -->
            <div class="legend">
                <h4>图例说明</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: red;"></div>
                    <span>高密度区域</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: yellow;"></div>
                    <span>中密度区域</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: blue;"></div>
                    <span>低密度区域</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>摄像头位置</span>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>

    <script>
        // 全局变量
        let map;
        let heatmapLayer;
        let markersLayer;
        let currentAnimal = '';
        let allHeatmapData = [];
        let allSensorData = [];
        let allAnimalStats = [];

        // 初始化地图
        function initMap() {
            // 创建地图实例 - 以中国为中心
            map = L.map('map').setView([35.0, 105.0], 5);

            // 添加地图图层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // 创建图层组
            markersLayer = L.layerGroup().addTo(map);

            console.log('🗺️ 地图初始化完成');
        }

        // 加载热力图数据
        async function loadHeatmapData(animalFilter = '') {
            try {
                const url = animalFilter ? 
                    `/api/heatmap-by-animal/${encodeURIComponent(animalFilter)}` : 
                    '/api/heatmap-data';
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success') {
                    allHeatmapData = result.data;
                    updateHeatmap();
                    console.log(`📊 加载了 ${result.count} 条热力图数据`);
                } else {
                    console.error('❌ 加载热力图数据失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 网络错误:', error);
            }
        }

        // 加载摄像头位置数据
        async function loadSensorData() {
            try {
                const response = await fetch('/api/sensor-locations');
                const result = await response.json();
                
                if (result.status === 'success') {
                    allSensorData = result.data;
                    updateSensorMarkers();
                    console.log(`📍 加载了 ${result.count} 个摄像头位置`);
                } else {
                    console.error('❌ 加载摄像头数据失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 网络错误:', error);
            }
        }

        // 加载动物统计数据
        async function loadAnimalStats() {
            try {
                const response = await fetch('/api/animal-stats');
                const result = await response.json();
                
                if (result.status === 'success') {
                    allAnimalStats = result.data;
                    updateAnimalFilter();
                    updateAnimalList();
                    updateStatsPanel();
                    console.log(`🐾 加载了 ${result.count} 种动物统计`);
                } else {
                    console.error('❌ 加载动物统计失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 网络错误:', error);
            }
        }

        // 更新热力图
        function updateHeatmap() {
            // 移除现有热力图
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }

            if (allHeatmapData.length === 0) {
                console.log('📊 没有热力图数据');
                return;
            }

            // 准备热力图数据
            const heatData = allHeatmapData.map(item => [
                item.latitude,
                item.longitude,
                item.intensity * parseFloat(document.getElementById('heatmapIntensity').value)
            ]);

            // 创建热力图图层
            heatmapLayer = L.heatLayer(heatData, {
                radius: parseInt(document.getElementById('heatmapRadius').value),
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.0: 'blue',
                    0.3: 'cyan',
                    0.5: 'lime',
                    0.7: 'yellow',
                    1.0: 'red'
                }
            }).addTo(map);

            console.log(`🔥 更新热力图: ${heatData.length} 个数据点`);
        }

        // 更新摄像头标记
        function updateSensorMarkers() {
            // 清除现有标记
            markersLayer.clearLayers();

            allSensorData.forEach(sensor => {
                const marker = L.circleMarker([sensor.latitude, sensor.longitude], {
                    radius: 8,
                    fillColor: '#3498db',
                    color: '#2980b9',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(`
                    <div style="font-family: Arial, sans-serif;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">📹 ${sensor.sensor_id}</h4>
                        <p style="margin: 5px 0;"><strong>位置:</strong> ${sensor.location}</p>
                        <p style="margin: 5px 0;"><strong>检测次数:</strong> ${sensor.total_detections}</p>
                        <p style="margin: 5px 0;"><strong>坐标:</strong> ${sensor.latitude.toFixed(4)}, ${sensor.longitude.toFixed(4)}</p>
                    </div>
                `);

                markersLayer.addLayer(marker);
            });

            console.log(`📍 更新了 ${allSensorData.length} 个摄像头标记`);
        }

        // 更新动物筛选器
        function updateAnimalFilter() {
            const select = document.getElementById('animalFilter');
            select.innerHTML = '<option value="">所有动物</option>';
            
            allAnimalStats.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.animal_name;
                option.textContent = `${animal.animal_name} (${animal.count})`;
                select.appendChild(option);
            });
        }

        // 更新动物列表
        function updateAnimalList() {
            const container = document.getElementById('animalList');
            
            if (allAnimalStats.length === 0) {
                container.innerHTML = '<div class="loading">暂无动物数据</div>';
                return;
            }

            container.innerHTML = allAnimalStats.map(animal => `
                <div class="animal-item" onclick="selectAnimal('${animal.animal_name}')" data-animal="${animal.animal_name}">
                    <strong>${animal.animal_name}</strong>
                    <small>检测次数: ${animal.count} | 摄像头: ${animal.sensor_count} | 置信度: ${animal.avg_confidence}%</small>
                </div>
            `).join('');
        }

        // 更新统计面板
        function updateStatsPanel() {
            const container = document.getElementById('statsContainer');
            
            const totalDetections = allAnimalStats.reduce((sum, animal) => sum + animal.count, 0);
            const totalSensors = allSensorData.length;
            const totalAnimals = allAnimalStats.length;

            container.innerHTML = `
                <div class="stats-item">
                    <h4>🎯 总检测次数</h4>
                    <p>${totalDetections.toLocaleString()} 次</p>
                </div>
                <div class="stats-item">
                    <h4>📹 摄像头数量</h4>
                    <p>${totalSensors} 个</p>
                </div>
                <div class="stats-item">
                    <h4>🐾 动物种类</h4>
                    <p>${totalAnimals} 种</p>
                </div>
                <div class="stats-item">
                    <h4>📊 当前筛选</h4>
                    <p>${currentAnimal || '所有动物'}</p>
                </div>
            `;
        }

        // 选择动物
        function selectAnimal(animalName) {
            currentAnimal = animalName;
            
            // 更新UI
            document.getElementById('animalFilter').value = animalName;
            
            // 更新动物列表选中状态
            document.querySelectorAll('.animal-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-animal="${animalName}"]`)?.classList.add('selected');
            
            // 重新加载热力图数据
            loadHeatmapData(animalName);
            updateStatsPanel();
        }

        // 刷新数据
        async function refreshData() {
            console.log('🔄 刷新所有数据...');
            await Promise.all([
                loadHeatmapData(currentAnimal),
                loadSensorData(),
                loadAnimalStats()
            ]);
        }

        // 重置视图
        function resetView() {
            map.setView([35.0, 105.0], 5);
            currentAnimal = '';
            document.getElementById('animalFilter').value = '';
            document.querySelectorAll('.animal-item').forEach(item => {
                item.classList.remove('selected');
            });
            loadHeatmapData();
            updateStatsPanel();
        }

        // 清除热力图
        function clearHeatmap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
        }

        // 事件监听器
        document.getElementById('animalFilter').addEventListener('change', function() {
            selectAnimal(this.value);
        });

        document.getElementById('heatmapIntensity').addEventListener('input', function() {
            document.getElementById('intensityValue').textContent = this.value;
            updateHeatmap();
        });

        document.getElementById('heatmapRadius').addEventListener('input', function() {
            document.getElementById('radiusValue').textContent = this.value + 'px';
            updateHeatmap();
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 页面加载完成，开始初始化...');
            
            initMap();
            
            // 延迟加载数据，确保地图完全初始化
            setTimeout(() => {
                refreshData();
            }, 1000);
        });

        // 窗口大小调整
        window.addEventListener('resize', function() {
            if (map) {
                map.invalidateSize();
            }
        });
    </script>
</body>
</html>